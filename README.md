Foreach and map function implementation